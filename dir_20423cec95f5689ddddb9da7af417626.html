<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Public ITA Client for C: examples/sgx_token Directory Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Public ITA Client for C
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dir_20423cec95f5689ddddb9da7af417626.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">sgx_token Directory Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="icondoc"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sgx__token_8c.html">sgx_token.c</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The SGX Token example is a C program that uses the Intel Trust Authority Attestation Client libraries to fetch token from Intel Trust Authority. The program contains an example SGX enclave. When run, it collects quote from the enclave and sends it to Intel Trust Authority to retrieve a token.</p>
<div class="fragment"><div class="line">┌────────────────────────────────────────────────┐</div>
<div class="line">│    ┌──────────────────────────────────────┐    │</div>
<div class="line">│    │          Docker Container            │    │</div>
<div class="line">│    │                                      │    │</div>
<div class="line">│    │    ┌──────────────────────────┐      │    │</div>
<div class="line">│    │    │        SGX Token         │      │    │                ┌────────────────┐</div>
<div class="line">│    │    └──────────────────────────┘      │    │                │                │</div>
<div class="line">│    │                                      │    │                │                │</div>
<div class="line">│    │    ┌──────────────────────────┐      │◄───┼───────────────►│ INTEL TRUST    |</div>
<div class="line">│    │    │     enclave.signed.so    │      │    │                │ AUTHORITY      |</div>
<div class="line">│    │    └──────────────────────────┘      │    │                │ CLIENT         |</div>
<div class="line">│    │                                      │    │                └────────────────┘   </div>
<div class="line">│    │    ┌──────────────────────────┐      |    |                                                  </div>
<div class="line">│    │    |libtrustauthotiy_sgx.so   |      |    |</div>
<div class="line">│    │    └──────────────────────────┘      │    │</div>
<div class="line">│    │                                      │    │              </div>
<div class="line">│    │    ┌──────────────────────────┐      │    │</div>
<div class="line">│    │    │      libtrustauthotiy_   |      |    |</div>
<div class="line">|    |    |      connector.so        │      │    │</div>
<div class="line">│    │    └──────────────────────────┘      │    │</div>
<div class="line">│    │                                      │    │</div>
<div class="line">│    │    ┌────────────────────────────┐    │    │</div>
<div class="line">│    │    │   libtrustauthotiy_        |    |    |</div>
<div class="line">|    |    |   token_provider.so        │    │    │</div>
<div class="line">│    │    └────────────────────────────┘    │    │</div>
<div class="line">│    │                                      │    │</div>
<div class="line">│    │    ┌────────────────────────────┐    │    │</div>
<div class="line">│    │    │  libtrustauthotiy_         |    |    |</div>
<div class="line">|    |    |  token_verifier.so         │    │    │</div>
<div class="line">│    │    └────────────────────────────┘    │    │</div>
<div class="line">│    │                                      │    │</div>
<div class="line">│    └──────────────────────────────────────┘    │</div>
<div class="line">│                                                │</div>
<div class="line">│                  SGX Host                      │</div>
<div class="line">└────────────────────────────────────────────────┘</div>
</div><!-- fragment --><p> The diagram above depicts the components used in the SGX Token while running within a docker container. The SGX Token example can also be run directly on a SGX host (provided the appropriate dependencies like DCAP have been installed).</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Prerequisites</h1>
<ul>
<li>Ability to build the Intel Trust Authority Attestation Client (see <a class="el" href="md_docs_2builds.html">Build Instructions</a>).</li>
<li>A <em>production</em> SGX host with the SGX driver and Docker installed.</li>
<li>The SGX host must be able to generate quotes.</li>
<li>A running instance of Intel Trust Authority.</li>
</ul>
<h1><a class="anchor" id="autotoc_md26"></a>
Build Instructions</h1>
<ul>
<li>Build SGX Token docker image in release/debug mode: <div class="fragment"><div class="line">- To Build in release mode:  </div>
<div class="line">  make sgx_token_docker</div>
<div class="line">- To Build in debug mode:  </div>
<div class="line">  make DEBUG=1 sgx_token_docker</div>
</div><!-- fragment --></li>
<li>When successfully built, running <code>docker image ls -a</code> includes <code>taas/sgx_token:v1.2.0</code>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md27"></a>
Deployment Instructions</h1>
<ul>
<li>The docker image must be present on the SGX host. For example, it can be exported/copied from a build machine as follows... <div class="fragment"><div class="line">#Save the sgx_token Docker image into trust_authority.sgx_token.tar.gz</div>
<div class="line">docker save taas/sgx_token:v1.2.0 &gt; trust_authority.sgx_token.tar.gz</div>
<div class="line">#scp trust_authority.sgx_token.tar.gz to the SGX host.</div>
<div class="line">#On the SGX host load/import trust_authority.sgx_token.tar.gz docker image using below command</div>
<div class="line">docker load -i trust_authority.sgx_token.tar.gz</div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md28"></a>
Running the Sample</h1>
<p>Running the sample requires the following steps...</p><ol type="1">
<li>Collect the mrenclave/mrsigner from the example enclave.</li>
<li>Creating an Intel Trust Authority policy that will be evaluated during token creation.</li>
<li>Running the SGX Token application via docker on an SGX Host.</li>
</ol>
<h2><a class="anchor" id="autotoc_md29"></a>
Example Environment Variables</h2>
<ul>
<li>The following table lists the environment variables used in sgx_token.env</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Variable   </th><th class="markdownTableHeadLeft">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">TRUSTAUTHORITY_API_KEY   </td><td class="markdownTableBodyLeft">The Intel Trust Authority API key.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">TRUSTAUTHORITY_API_URL   </td><td class="markdownTableBodyLeft">The Intel Trust Authority API URL.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">TRUSTAUTHORITY_POLICY_ID   </td><td class="markdownTableBodyLeft">The policy id created using Intel Trust Authority portal.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">TRUSTAUTHORITY_BASE_URL   </td><td class="markdownTableBodyLeft">The base url of Intel Trust Authority certificate management authority to download certificate to verify token in Azure. (ex. '<a href="https://portal.trustauthority.intel.com'">https://portal.trustauthority.intel.com'</a>)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">REQUEST_ID   </td><td class="markdownTableBodyLeft">An optional parameter to trace the request.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">TOKEN_SIGNING_ALG   </td><td class="markdownTableBodyLeft">An optional parameter to specify token signing algorithm, supported algorithms are RS256, PS384.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">POLICY_MUST_MATCH   </td><td class="markdownTableBodyLeft">An optional boolean parameter to enforce policies match during attestation, supported values are true/false.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">RETRY_WAIT_TIME   </td><td class="markdownTableBodyLeft">Wait time between retries. Default value is 2 seconds.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">RETRY_MAX   </td><td class="markdownTableBodyLeft">Maximum number of retries. Default value is 2 seconds.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md30"></a>
Run the example...</h2>
<div class="fragment"><div class="line">#Creating sgx_token.env file</div>
<div class="line">cat &lt;&lt;EOF | tee sgx_token.env</div>
<div class="line">TRUSTAUTHORITY_API_KEY=&lt;trustauthority-api-key&gt;</div>
<div class="line">TRUSTAUTHORITY_POLICY_ID=&lt;trustauthority-policy-id&gt;</div>
<div class="line">TRUSTAUTHORITY_API_URL=&quot;https://api.trustauthority.intel.com&quot;</div>
<div class="line">TRUSTAUTHORITY_BASE_URL=&quot;https://portal.trustauthority.intel.com&quot;</div>
<div class="line">SGX_AESM_ADDR=1</div>
<div class="line">EOF</div>
<div class="line">#Use docker to run the SGX Token example...</div>
<div class="line">sudo docker run -it --rm --device=/dev/sgx_enclave --device=/dev/sgx_provision -v /var/run/aesmd/aesm.socket:/var/run/aesmd/aesm.socket --env-file sgx_token.env --group-add $(getent group sgx_prv | cut -d: -f3) taas/sgx_token:v1.2.0</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md31"></a>
Output when example is run...</h2>
<ul>
<li>When successful, the token and other information will be dispayed... </li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_d28a4824dc47e487b107a5db32ef43c4.html">examples</a></li><li class="navelem"><a class="el" href="dir_20423cec95f5689ddddb9da7af417626.html">sgx_token</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
